name: AI Security Audit (Solidity)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Audit mode (auto = rotate)"
        required: false
        default: "auto"
        type: choice
        options:
          - auto
          - access-control
          - upgradeability
          - reentrancy
          - signatures-crypto
          - dos-griefing
          - invariants
          - economics-mev
      model:
        description: "Codex model override (optional)"
        required: false
        default: ""
      effort:
        description: "Reasoning effort"
        required: false
        default: "high"
        type: choice
        options:
          - low
          - medium
          - high
      variant:
        description: "Prompt variant (auto = rotate)"
        required: false
        default: "auto"
        type: choice
        options:
          - auto
          - a
          - b
  schedule:
    # Daily at 02:17 UTC (staggered to avoid competing with other repos at :00)
    - cron: "17 2 * * *"
  push:
    branches:
      - main
      - integration/dev
    paths:
      - "src/**"
      - "test/**"
      - "script/**"
      - "foundry.toml"
      - ".github/prompts/**"
      - ".github/workflows/ai-security-audit.yml"

permissions:
  contents: read

concurrency:
  group: ai-security-audit-solidity-${{ github.ref }}
  cancel-in-progress: true

jobs:
  audit:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Select audit mode
        id: mode
        shell: bash
        env:
          MODE_OVERRIDE: ${{ github.event.inputs.mode }}
          EFFORT_OVERRIDE: ${{ github.event.inputs.effort }}
          VARIANT_OVERRIDE: ${{ github.event.inputs.variant }}
        run: |
          set -euo pipefail

          MODES=(
            "access-control"
            "upgradeability"
            "reentrancy"
            "signatures-crypto"
            "dos-griefing"
            "invariants"
            "economics-mev"
          )

          VARIANTS=("a" "b")

          MODE="${MODE_OVERRIDE:-}"
          if [ -z "$MODE" ] || [ "$MODE" = "auto" ]; then
            INDEX=$((GITHUB_RUN_NUMBER % ${#MODES[@]}))
            MODE="${MODES[$INDEX]}"
          else
            OK="false"
            for M in "${MODES[@]}"; do
              if [ "$M" = "$MODE" ]; then
                OK="true"
                break
              fi
            done
            if [ "$OK" != "true" ]; then
              echo "Invalid mode: $MODE" >&2
              exit 1
            fi
          fi

          VARIANT="${VARIANT_OVERRIDE:-}"
          if [ -z "$VARIANT" ] || [ "$VARIANT" = "auto" ]; then
            # Rotate variants more slowly than modes: every full mode-cycle switches the variant.
            VAR_INDEX=$(((GITHUB_RUN_NUMBER / ${#MODES[@]}) % ${#VARIANTS[@]}))
            VARIANT="${VARIANTS[$VAR_INDEX]}"
          else
            OK="false"
            for V in "${VARIANTS[@]}"; do
              if [ "$V" = "$VARIANT" ]; then
                OK="true"
                break
              fi
            done
            if [ "$OK" != "true" ]; then
              echo "Invalid variant: $VARIANT" >&2
              exit 1
            fi
          fi

          EFFORT="${EFFORT_OVERRIDE:-}"
          if [ -z "$EFFORT" ]; then
            EFFORT="high"
          fi
          if [ "$EFFORT" != "low" ] && [ "$EFFORT" != "medium" ] && [ "$EFFORT" != "high" ]; then
            echo "Invalid effort: $EFFORT" >&2
            exit 1
          fi

          echo "mode=$MODE" >> "$GITHUB_OUTPUT"
          echo "variant=$VARIANT" >> "$GITHUB_OUTPUT"
          echo "effort=$EFFORT" >> "$GITHUB_OUTPUT"

          PROMPT_FILE=".github/prompts/solidity/${MODE}.md"
          if [ "$VARIANT" = "b" ]; then
            PROMPT_FILE=".github/prompts/solidity/${MODE}.b.md"
          fi
          if [ ! -f "$PROMPT_FILE" ]; then
            echo "Missing prompt file: $PROMPT_FILE" >&2
            exit 1
          fi

          echo "prompt_file=$PROMPT_FILE" >> "$GITHUB_OUTPUT"
          echo "report_file=reports/ai-security-audit-solidity-${MODE}-${VARIANT}.md" >> "$GITHUB_OUTPUT"

      - name: Select OpenAI API key (fallback pool)
        id: key
        shell: bash
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_API_KEY_1: ${{ secrets.OPENAI_API_KEY_1 }}
          OPENAI_API_KEY_2: ${{ secrets.OPENAI_API_KEY_2 }}
          OPENAI_API_KEY_3: ${{ secrets.OPENAI_API_KEY_3 }}
          OPENAI_API_KEY_4: ${{ secrets.OPENAI_API_KEY_4 }}
          OPENAI_API_KEY_5: ${{ secrets.OPENAI_API_KEY_5 }}
        run: |
          set -euo pipefail

          # Prefer OPENAI_API_KEY, then numbered keys.
          KEYS=(
            "${OPENAI_API_KEY:-}"
            "${OPENAI_API_KEY_1:-}"
            "${OPENAI_API_KEY_2:-}"
            "${OPENAI_API_KEY_3:-}"
            "${OPENAI_API_KEY_4:-}"
            "${OPENAI_API_KEY_5:-}"
          )

          for KEY in "${KEYS[@]}"; do
            if [ -z "$KEY" ]; then
              continue
            fi

            # Cheap health check: if the key is invalid/quota-exhausted, this typically fails with 401/429.
            CODE="$(curl -sS -o /dev/null -w '%{http_code}' \
              -H "Authorization: Bearer $KEY" \
              https://api.openai.com/v1/models || true)"

            if [ "$CODE" = "200" ]; then
              echo "OPENAI_API_KEY=$KEY" >> "$GITHUB_ENV"
              echo "ok=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          done

          echo "No usable OpenAI API key found. Configure secrets OPENAI_API_KEY or OPENAI_API_KEY_{1..5}." >&2
          exit 1

      - name: Prepare report folder
        run: |
          set -euo pipefail
          mkdir -p reports

      - name: Run AI audit (full repo context)
        id: codex
        uses: openai/codex-action@086169432f1d2ab2f4057540b1754d550f6a1189 # v1.4
        with:
          openai-api-key: ${{ env.OPENAI_API_KEY }}
          prompt-file: ${{ steps.mode.outputs.prompt_file }}
          output-file: ${{ steps.mode.outputs.report_file }}
          sandbox: read-only
          model: ${{ github.event.inputs.model }}
          effort: ${{ steps.mode.outputs.effort }}
          allow-bots: true
          safety-strategy: drop-sudo

      - name: Job summary
        if: always()
        shell: bash
        run: |
          {
            echo "## AI Solidity Security Audit"
            echo ""
            echo "- Mode: \`${{ steps.mode.outputs.mode }}\`"
            echo "- Variant: \`${{ steps.mode.outputs.variant }}\`"
            echo "- Prompt: \`${{ steps.mode.outputs.prompt_file }}\`"
            echo "- Report: \`${{ steps.mode.outputs.report_file }}\`"
            if [ -n "${{ github.event.inputs.model }}" ]; then
              echo "- Model override: \`${{ github.event.inputs.model }}\`"
            fi
            echo "- Effort: \`${{ steps.mode.outputs.effort }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-security-audit-solidity-${{ steps.mode.outputs.mode }}-${{ steps.mode.outputs.variant }}
          path: ${{ steps.mode.outputs.report_file }}
          if-no-files-found: error
